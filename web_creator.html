<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Dashboard - AMDF.GROUP</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --background-start: #f0f2f5;
            --background-end: #e0e2e5;
            --text-color: #333;
            --header-bg: rgba(255, 255, 255, 0.9);
            --header-border: #eee;
            --container-bg: #ffffff;
            --container-border: #ddd;
            --container-shadow: rgba(0, 0, 0, 0.08);
            --button-bg-gradient-start: #6a11cb;
            --button-bg-gradient-end: #2575fc;
            --button-text-color: #fff;
            --link-color: #007bff;
            --input-bg: #f9f9f9;
            --input-border: #ccc;
            --input-text: #333;
            --toggle-bg: #ddd;
            --toggle-circle-bg: #fff;
            --toggle-shadow: rgba(0, 0, 0, 0.2);
            --footer-bg: #333;
            --footer-text: #eee;
        }

        body.dark-mode {
            --background-start: #1a1a2e;
            --background-end: #16213e;
            --text-color: #e0e0e0;
            --header-bg: rgba(26, 26, 46, 0.9);
            --header-border: #333;
            --container-bg: #22253b;
            --container-border: #444;
            --container-shadow: rgba(0, 0, 0, 0.4);
            --button-bg-gradient-start: #8e2de2;
            --button-bg-gradient-end: #4a00e0;
            --button-text-color: #fff;
            --link-color: #8e2de2;
            --input-bg: #33364f;
            --input-border: #555;
            --input-text: #e0e0e0;
            --toggle-bg: #555;
            --toggle-circle-bg: #bbb;
            --toggle-shadow: rgba(0, 0, 0, 0.4);
            --footer-bg: #111;
            --footer-text: #bbb;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--background-start), var(--background-end));
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease, color 0.3s ease;
        }

        header {
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--header-border);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px var(--container-shadow);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-color);
            text-decoration: none;
            background: linear-gradient(45deg, var(--button-bg-gradient-start), var(--button-bg-gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-back, #logoutButton {
            background: linear-gradient(45deg, var(--button-bg-gradient-start) 0%, var(--button-bg-gradient-end) 100%);
            color: var(--button-text-color);
            padding: 0.7rem 1.4rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            white-space: nowrap;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-back:hover, #logoutButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--container-shadow);
        }

        .mode-toggle {
            width: 50px;
            height: 25px;
            background-color: var(--toggle-bg);
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
        }

        .mode-toggle .circle {
            width: 20px;
            height: 20px;
            background-color: var(--toggle-circle-bg);
            border-radius: 50%;
            position: absolute;
            top: 2.5px;
            left: 2.5px;
            transition: transform 0.3s ease, background-color 0.3s ease;
            box-shadow: 0 2px 5px var(--toggle-shadow);
        }

        body.dark-mode .mode-toggle .circle {
            transform: translateX(25px);
        }

        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 5%;
        }

        .container {
            background-color: var(--container-bg);
            border: 1px solid var(--container-border);
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--container-shadow);
            padding: 2.5rem;
            max-width: 900px;
            width: 100%;
            margin-bottom: 2rem;
            text-align: center;
        }

        h1, h2 {
            font-size: 2.2rem;
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }
        h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        body.dark-mode .message.success {
            background-color: #214b2d;
            color: #d4edda;
            border: 1px solid #3c763d;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        body.dark-mode .message.error {
            background-color: #6d1e24;
            color: #f8d7da;
            border: 1px solid #a83d47;
        }
        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        body.dark-mode .message.info {
            background-color: #1c6b79;
            color: #d1ecf1;
            border: 1px solid #3c8d99;
        }

        .form-group {
            margin-bottom: 1.2rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="file"],
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--input-text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--link-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }

        .char-count {
            font-size: 0.85rem;
            color: var(--text-color);
            margin-top: 0.2rem;
            text-align: right;
        }
        .char-count.invalid {
            color: #dc3545; /* Red for invalid count */
            font-weight: 600;
        }

        button[type="submit"], .btn.edit, .btn.delete, #cancelEditBtn {
            background: linear-gradient(45deg, var(--button-bg-gradient-start) 0%, var(--button-bg-gradient-end) 100%);
            color: var(--button-text-color);
            padding: 0.9rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 1rem;
            margin-right: 0.5rem;
        }

        button[type="submit"]:hover, .btn.edit:hover, .btn.delete:hover, #cancelEditBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--container-shadow);
        }
        .btn.delete {
            background: linear-gradient(45deg, #dc3545 0%, #a81c2f 100%);
        }
        .btn.edit {
            background: linear-gradient(45deg, #ffc107 0%, #e0a800 100%);
            color: #333;
        }

        .story-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 2rem;
            width: 100%;
        }

        .story-item {
            background-color: var(--container-bg);
            border: 1px solid var(--container-border);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--container-shadow);
            padding: 1.5rem;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s ease;
        }
        .story-item:hover {
            transform: translateY(-5px);
        }
        .story-item h3 {
            margin-bottom: 0.5rem;
            font-size: 1.4rem;
            color: var(--text-color);
        }
        .story-item p {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-bottom: 0.3rem;
        }
        .story-item .story-id {
            font-size: 0.8rem;
            color: #666;
        }
        .story-item .status {
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        .status.pending { background-color: #ffc107; color: #333; }
        .status.approved { background-color: #28a745; color: #fff; }
        .status.rejected { background-color: #dc3545; color: #fff; }
        body.dark-mode .status.pending { background-color: #e0a800; color: #eee; }
        body.dark-mode .status.approved { background-color: #218838; color: #fff; }
        body.dark-mode .status.rejected { background-color: #a81c2f; color: #fff; }

        .item-actions {
            margin-top: 1rem;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .item-actions .btn {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
        }

        footer {
            background-color: var(--footer-bg);
            color: var(--footer-text);
            text-align: center;
            padding: 1.5rem 5%;
            margin-top: auto;
            border-top: 1px solid var(--header-border);
        }

        footer nav a {
            color: var(--footer-text);
            text-decoration: none;
            margin: 0 10px;
            transition: color 0.3s ease;
        }

        footer nav a:hover {
            color: var(--link-color);
        }

        /* --- Popup Provision Styles --- */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .provision-popup {
            background-color: var(--container-bg);
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: fadeInScale 0.3s ease-out forwards;
            color: var(--text-color);
        }

        .provision-popup h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .provision-popup ol {
            list-style-type: decimal;
            margin-left: 20px;
            padding-left: 0;
            font-size: 0.95rem;
            line-height: 1.8;
            text-align: left;
        }

        .provision-popup ol li {
            margin-bottom: 1rem;
        }
        .provision-popup ol li strong {
            color: var(--link-color);
        }
        .provision-popup ol li p {
            margin-top: 0.5rem;
        }

        .provision-popup .agreement-checkbox {
            margin-top: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .provision-popup .agreement-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            accent-color: var(--button-bg-gradient-end); /* Warna kotak centang */
        }

        .provision-popup button {
            background: linear-gradient(45deg, var(--button-bg-gradient-start) 0%, var(--button-bg-gradient-end) 100%);
            color: var(--button-text-color);
            padding: 0.9rem 2rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 2rem;
            width: auto;
            min-width: 150px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
        }
        .provision-popup button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--container-shadow);
        }
        .provision-popup button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem 4%;
            }
            .logo {
                margin-bottom: 1rem;
            }
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            .btn-back, #logoutButton {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            .mode-toggle {
                position: static;
                margin-left: auto;
            }
            main {
                padding: 1.5rem 4%;
            }
            .container {
                padding: 1.5rem;
            }
            h1 {
                font-size: 1.8rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            .form-group input, .form-group textarea, button[type="submit"] {
                padding: 0.7rem;
                font-size: 1rem;
            }
            .story-list {
                grid-template-columns: 1fr;
            }
            .provision-popup {
                padding: 20px;
                width: 95%;
            }
            .provision-popup h2 {
                font-size: 1.5rem;
            }
            .provision-popup ol {
                font-size: 0.9rem;
            }
            .provision-popup .agreement-checkbox {
                font-size: 1rem;
            }
            .provision-popup button {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }
            h1 {
                font-size: 1.6rem;
            }
            .item-actions {
                flex-direction: column;
                gap: 5px;
            }
            .item-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="provisionPopupOverlay" class="popup-overlay" style="display: none;">
        <div class="provision-popup">
            <h2>📜 Story Submission Guidelines for ebook_amdf.group</h2>
            <p>To maintain the quality, originality, and integrity of our content, all writers submitting their stories to ebook_amdf.group must comply with the following terms and conditions:</p>
            <ol>
                <li><strong>Original Work Only</strong>
                    <p>All submitted stories must be the original creation of the author. Submissions that are plagiarized, translated, adapted, or heavily inspired by existing stories (including books, films, comics, or anime) are strictly prohibited. The author takes full legal responsibility for the authenticity of the work.</p>
                </li>
                <li><strong>No Copyright Infringement</strong>
                    <p>Do not include characters, plots, settings, or elements from well-known or copyrighted works. Stories that contain copyrighted material without permission will be removed immediately.</p>
                </li>
                <li><strong>Prohibited Content</strong>
                    <p>Submitted stories must not contain any of the following:</p>
                    <ul>
                        <li>Pornographic or sexually explicit content</li>
                        <li>Hate speech or discriminatory content (racial, religious, gender-based, etc.)</li>
                        <li>Graphic violence or inhumane torture</li>
                        <li>Political propaganda or misleading ideologies</li>
                        <li>Any illegal or law-violating content</li>
                    </ul>
                </li>
                <li><strong>Language and Style</strong>
                    <p>Use proper, respectful, and appropriate language. The story should be written in clear English or Indonesian with minimal spelling and grammar errors. Slang or harsh language is only allowed if it is necessary and relevant to the storyline.</p>
                </li>
                <li><strong>Publication Status</strong>
                    <p>The story must not have been published on any commercial publishing platforms or major websites. Personal blogs or social media publication is allowed, but the story must not be under any exclusive contract.</p>
                </li>
                <li><strong>Word and Character Limit</strong>
                    <p>Minimum: 2,400 characters<br>Maximum: 2,700 characters<br>Stories must be written directly in the provided text editor. We do not accept uploaded files.</p>
                </li>
                <li><strong>Images and Illustrations</strong>
                    <p>If you include images or illustrations, they must be created by yourself. Do not use images from Google, stock photo websites, or any other sources that do not allow commercial use. You are responsible for ensuring your images do not violate copyright laws.</p>
                </li>
                <li><strong>Rights and Permission</strong>
                    <p>By submitting your work, you grant ebook_amdf.group the right to publish your story digitally on our platform, while your copyright remains your own. We reserve the right to lightly edit your story for clarity, grammar, or formatting if needed. Your name will be credited as the original author.</p>
                </li>
                <li><strong>Legal Responsibility</strong>
                    <p>If your work is found to violate copyright laws, or includes plagiarism or harmful content, you will be held fully responsible, and your story will be permanently removed from our platform.</p>
                </li>
            </ol>
            <div class="agreement-checkbox">
                <input type="checkbox" id="agreeToProvisions">
                <label for="agreeToProvisions">✅ By submitting your story to ebook_amdf.group, you confirm that you have read, understood, and agreed to all the terms above.</label>
            </div>
            <button id="acceptProvisionsBtn" disabled>Accept & Continue</button>
        </div>
    </div>
    <header>
        <a href="index.html" class="logo">AMDF.GROUP</a>
        <div class="header-actions">
            <a href="index.html" class="btn-back"><i class="fas fa-arrow-left"></i> Back to Catalog</a>
            <button id="logoutButton">Logout <i class="fas fa-sign-out-alt"></i></button>
            <div class="mode-toggle" onclick="toggleDarkMode()">
                <div class="circle"></div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <h1 id="welcomeMessage">Welcome, Creator!</h1>
            <div id="message" class="message" style="display:none;"></div>
        </div>

        <section id="storyManagementSection" class="container" style="display:none;">
            <h2 id="storyFormTitle">Create New Story</h2>
            <form id="storyForm">
                <input type="hidden" id="storyId">
                <div class="form-group">
                    <label for="storyTitle">Story Title</label>
                    <input type="text" id="storyTitle" placeholder="Enter your story title" required>
                </div>
                <div class="form-group">
                    <label for="storyGenre">Genre</label>
                    <input type="text" id="storyGenre" placeholder="e.g., Fantasy, Sci-Fi, Romance" required>
                </div>
                <div class="form-group">
                    <label for="storyContent">Story Content</label>
                    <textarea id="storyContent" placeholder="Write your story here..." required></textarea>
                    <div class="char-count" id="contentCharCount">0 characters</div>
                </div>
                <div class="form-group">
                    <label for="storyThumbnail">Thumbnail (Format: WEBP, Max 200KB)</label>
                    <input type="file" id="storyThumbnail" accept=".webp">
                </div>
                <button type="submit" id="submitStoryBtn">Publish Story</button>
                <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
            </form>
        </section>

        <section id="myStoriesSection" class="container" style="display:none;">
            <h2>My Stories</h2>
            <div id="storyList" class="story-list">
                </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 AMDF.GROUP. All rights reserved.</p>
        <nav>
            <a href="about.html">About Us</a> |
            <a href="privacy_policy.html">Privacy Policy</a> |
            <a href="terms_of_service.html">Terms of Service</a>
        </nav>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, sendEmailVerification, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, getDoc, updateDoc, deleteDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyDeiLybtGc6evATj5O7M1FiJd1GPYd-rYc",
            authDomain: "tamplatedoc.firebaseapp.com",
            databaseURL: "https://tamplatedoc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tamplatedoc",
            storageBucket: "tamplatedoc.firebasestorage.app",
            messagingSenderId: "264966107720",
            appId: "1:264966107720:web:868abe93cdff209040de7d",
            measurementId: "G-S5WTZ7S5PG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Dark Mode / Light Mode Logic ---
        function applyTheme() {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        }

        // --- DOM Elements ---
        const welcomeMessage = document.getElementById('welcomeMessage');
        const logoutButton = document.getElementById('logoutButton');
        const storyForm = document.getElementById('storyForm');
        const storyIdInput = document.getElementById('storyId');
        const storyTitleInput = document.getElementById('storyTitle');
        const storyGenreInput = document.getElementById('storyGenre');
        const storyContentInput = document.getElementById('storyContent');
        const contentCharCount = document.getElementById('contentCharCount');
        const storyThumbnailInput = document.getElementById('storyThumbnail');
        const submitStoryBtn = document.getElementById('submitStoryBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const storyFormTitle = document.getElementById('storyFormTitle');
        const messageDiv = document.getElementById('message');
        const storyListDiv = document.getElementById('storyList');

        // Section elements to hide/show based on email verification
        const storyManagementSection = document.getElementById('storyManagementSection');
        const myStoriesSection = document.getElementById('myStoriesSection');

        // Popup Provision Elements
        const provisionPopupOverlay = document.getElementById('provisionPopupOverlay');
        const agreeToProvisionsCheckbox = document.getElementById('agreeToProvisions');
        const acceptProvisionsBtn = document.getElementById('acceptProvisionsBtn');

        let currentAuthorName = '';
        let currentUserId = '';
        let creatorStoryCount = 0; // To keep track of stories created by the current user

        // --- Authentication State Listener ---
        let initialAuthCheckDone = false; // Flag to prevent multiple redirects or redirect loops

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;

                if (!user.emailVerified) {
                    welcomeMessage.textContent = `Welcome, ${user.displayName || user.email}! Please verify your email.`;
                    showMessage("Your email is not verified. Please check your inbox for a verification link. " +
                                "If you haven't received one, click here to <a href='#' id='resendVerificationLink'>resend</a>.", "error");

                    if (storyManagementSection) storyManagementSection.style.display = 'none';
                    if (myStoriesSection) myStoriesSection.style.display = 'none';

                    const resendLink = document.getElementById('resendVerificationLink');
                    if (resendLink) {
                        resendLink.addEventListener('click', async (e) => {
                            e.preventDefault();
                            try {
                                await sendEmailVerification(user);
                                showMessage("Verification email sent! Please check your inbox.", "success");
                            } catch (error) {
                                showMessage("Error sending verification email: " + error.message, "error");
                                console.error("Error sending verification email:", error);
                            }
                        });
                    }
                    initialAuthCheckDone = true;
                    return;
                }

                // Email already verified, proceed
                const authorDocRef = doc(db, "authors", user.uid);
                const authorDocSnap = await getDoc(authorDocRef);
                if (authorDocSnap.exists()) {
                    currentAuthorName = authorDocSnap.data().name;
                    welcomeMessage.textContent = `Welcome, ${currentAuthorName}!`;
                    listenForCreatorStories(user.uid);
                } else {
                    currentAuthorName = user.displayName || user.email.split('@')[0];
                    welcomeMessage.textContent = `Welcome, Creator!`;
                    listenForCreatorStories(user.uid);
                }

                if (storyManagementSection) storyManagementSection.style.display = 'block';
                if (myStoriesSection) myStoriesSection.style.display = 'block';

                initialAuthCheckDone = true;

                // Check if provisions have been accepted
                if (!localStorage.getItem('provisionsAccepted')) {
                    provisionPopupOverlay.style.display = 'flex';
                }

            } else {
                if (!initialAuthCheckDone && window.location.pathname.endsWith('creator_dashboard.html')) {
                    window.location.href = 'login_register_creator.html';
                }
                initialAuthCheckDone = true;
            }
        });

        // --- Logout Functionality ---
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                localStorage.removeItem('provisionsAccepted'); // Clear agreement on logout
                window.location.href = 'login_register_creator.html';
            } catch (error) {
                showMessage("Logout failed: " + error.message, "error");
            }
        });

        // --- Message Display Function ---
        function showMessage(text, type) {
            messageDiv.innerHTML = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // --- Popup Provision Logic ---
        agreeToProvisionsCheckbox.addEventListener('change', () => {
            acceptProvisionsBtn.disabled = !agreeToProvisionsCheckbox.checked;
        });

        acceptProvisionsBtn.addEventListener('click', () => {
            if (agreeToProvisionsCheckbox.checked) {
                localStorage.setItem('provisionsAccepted', 'true');
                provisionPopupOverlay.style.display = 'none';
            }
        });

        // --- Thumbnail Management Functions ---
        async function uploadThumbnail(file, storyFirestoreDocId) {
            if (!file) return null;
            const storagePath = `thumbnails/${storyFirestoreDocId}/${file.name}`;
            const imageRef = storageRef(storage, storagePath);
            await uploadBytes(imageRef, file);
            return storagePath;
        }

        async function deleteThumbnail(path) {
            if (!path) return;
            const imageRef = storageRef(storage, path);
            try {
                await deleteObject(imageRef);
            } catch (error) {
                if (error.code === 'storage/object-not-found') {
                    console.warn("Attempted to delete a thumbnail that doesn't exist:", path);
                } else {
                    console.error("Error deleting old thumbnail:", error);
                }
            }
        }

        // --- Function to generate Story ID (for public display, not Firestore Doc ID) ---
        function generateStoryId(creatorUid, storyCount) {
            const now = new Date();
            const year = String(now.getFullYear()).slice(2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');

            let creatorIdHash = 0;
            for (let i = 0; i < Math.min(creatorUid.length, 4); i++) {
                creatorIdHash += creatorUid.charCodeAt(i);
            }
            creatorIdHash = String(creatorIdHash % 10000).padStart(4, '0');

            const storyNum = String(storyCount || 0).slice(-1);

            return `${year}${month}${day}${creatorIdHash}${storyNum}`;
        }

        // --- Character Count for Story Content ---
        storyContentInput.addEventListener('input', () => {
            const charCount = storyContentInput.value.length;
            contentCharCount.textContent = `${charCount} characters`;

            if (charCount < 2400 || charCount > 2700) {
                contentCharCount.classList.add('invalid');
            } else {
                contentCharCount.classList.remove('invalid');
            }
        });

        // --- Story Form Submission Handler ---
        storyForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate character count
            const content = storyContentInput.value.trim();
            const charCount = content.length;
            if (charCount < 2400 || charCount > 2700) {
                showMessage("Story content must be between 2400 and 2700 characters.", "error");
                return;
            }

            // Validate thumbnail file
            const thumbnailFile = storyThumbnailInput.files[0];
            if (thumbnailFile) {
                if (thumbnailFile.type !== 'image/webp') {
                    showMessage("Thumbnail must be in WEBP format.", "error");
                    return;
                }
                if (thumbnailFile.size > 200 * 1024) { // 200 KB in bytes
                    showMessage("Thumbnail size must not exceed 200KB.", "error");
                    return;
                }
            }

            // Ensure provisions are accepted
            if (!localStorage.getItem('provisionsAccepted')) {
                showMessage("Please accept the story submission guidelines before submitting your story.", "error");
                provisionPopupOverlay.style.display = 'flex'; // Re-show popup if not accepted
                return;
            }

            const storyFirestoreDocId = storyIdInput.value;
            const title = storyTitleInput.value.trim();
            const genre = storyGenreInput.value.trim();

            if (!title || !genre || !content) {
                showMessage("Please fill in all required fields (Title, Genre, Content).", "error");
                return;
            }

            if (!currentUserId || !currentAuthorName) {
                showMessage("Authentication error. Please log in again.", "error");
                return;
            }

            submitStoryBtn.disabled = true;
            submitStoryBtn.textContent = storyFirestoreDocId ? 'Updating...' : 'Publishing...';

            try {
                let thumbnailPath = null;

                if (storyFirestoreDocId) {
                    // --- Editing an existing story ---
                    const storyDocRef = doc(db, "stories", storyFirestoreDocId);
                    const storyDocSnap = await getDoc(storyDocRef);
                    const oldThumbnailPath = storyDocSnap.exists() ? storyDocSnap.data().thumbnailPath : null;

                    if (thumbnailFile) {
                        if (oldThumbnailPath) {
                            await deleteThumbnail(oldThumbnailPath);
                        }
                        thumbnailPath = await uploadThumbnail(thumbnailFile, storyFirestoreDocId);
                    } else {
                        thumbnailPath = oldThumbnailPath;
                    }

                    await updateDoc(storyDocRef, {
                        title: title,
                        genre: genre,
                        content: content,
                        thumbnailPath: thumbnailPath,
                        lastModified: serverTimestamp(),
                        status: 'pending' // Status changes to pending upon edit
                    });
                    showMessage("Story updated successfully! Awaiting staff approval.", "success");

                } else {
                    // --- Creating a new story ---
                    const newStoryData = {
                        authorUid: currentUserId,
                        authorName: currentAuthorName,
                        title: title,
                        genre: genre,
                        content: content,
                        createdAt: serverTimestamp(),
                        lastModified: serverTimestamp(),
                        status: 'pending',
                        thumbnailPath: null
                    };

                    const docRef = await addDoc(collection(db, "stories"), newStoryData);
                    const newFirestoreDocId = docRef.id;

                    const newCustomStoryId = generateStoryId(currentUserId, creatorStoryCount + 1);

                    if (thumbnailFile) {
                        thumbnailPath = await uploadThumbnail(thumbnailFile, newFirestoreDocId);
                    }

                    await updateDoc(doc(db, "stories", newFirestoreDocId), {
                        storyId: newCustomStoryId,
                        thumbnailPath: thumbnailPath
                    });

                    showMessage("Story published successfully! Awaiting staff approval.", "success");
                }
                resetForm();
            } catch (error) {
                console.error("Error submitting story:", error);
                showMessage("Error submitting story: " + error.message, "error");
            } finally {
                submitStoryBtn.disabled = false;
                submitStoryBtn.textContent = storyIdInput.value ? 'Update Story' : 'Publish Story';
            }
        });

        // --- Form Reset Function ---
        function resetForm() {
            storyForm.reset();
            storyIdInput.value = '';
            storyFormTitle.textContent = 'Create New Story';
            submitStoryBtn.textContent = 'Publish Story';
            cancelEditBtn.style.display = 'none';
            contentCharCount.textContent = '0 characters'; // Reset character count display
            contentCharCount.classList.remove('invalid'); // Remove invalid class
        }

        cancelEditBtn.addEventListener('click', resetForm);

        // --- Listener for Creator's Stories ---
        function listenForCreatorStories(authorUid) {
            const storiesQuery = query(collection(db, "stories"), where("authorUid", "==", authorUid));
            onSnapshot(storiesQuery, async (snapshot) => {
                storyListDiv.innerHTML = '';
                creatorStoryCount = snapshot.size;

                if (snapshot.empty) {
                    storyListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">You have not published any stories yet. Start writing now!</p>';
                    return;
                }

                for (const docSnapshot of snapshot.docs) {
                    const story = { id: docSnapshot.id, ...docSnapshot.data() };
                    const storyItem = document.createElement('div');
                    storyItem.className = 'story-item';

                    let thumbnailUrl = '';
                    if (story.thumbnailPath) {
                        try {
                            thumbnailUrl = await getDownloadURL(storageRef(storage, story.thumbnailPath));
                        } catch (e) {
                            console.error("Error fetching thumbnail URL for story", story.id, ":", e);
                            thumbnailUrl = '';
                        }
                    }

                    storyItem.innerHTML = `
                        ${thumbnailUrl ? `<img src="${thumbnailUrl}" alt="Story Thumbnail" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">` : ''}
                        <h3>${story.title}</h3>
                        <p class="story-id">ID: ${story.storyId || 'N/A'}</p>
                        <p>Genre: ${story.genre}</p>
                        <p>Status: <span class="status ${story.status}">${story.status.charAt(0).toUpperCase() + story.status.slice(1)}</span></p>
                        ${story.createdAt ? `<p>Created: ${new Date(story.createdAt.toDate()).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</p>` : ''}
                        ${story.lastModified ? `<p>Last Modified: ${new Date(story.lastModified.toDate()).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</p>` : ''}
                        <div class="item-actions">
                            <button class="btn edit" data-id="${story.id}">Edit</button>
                            <button class="btn delete" data-id="${story.id}" data-thumbnail="${story.thumbnailPath || ''}">Delete</button>
                        </div>
                    `;
                    storyListDiv.appendChild(storyItem);
                }

                // Add event listeners for edit and delete buttons after stories are rendered
                document.querySelectorAll('.btn.edit').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const storyIdToEdit = e.target.dataset.id;
                        const storyDoc = await getDoc(doc(db, "stories", storyIdToEdit));
                        if (storyDoc.exists()) {
                            const storyData = storyDoc.data();
                            storyIdInput.value = storyIdToEdit;
                            storyTitleInput.value = storyData.title;
                            storyGenreInput.value = storyData.genre;
                            storyContentInput.value = storyData.content;
                            storyFormTitle.textContent = 'Edit Story';
                            submitStoryBtn.textContent = 'Update Story';
                            cancelEditBtn.style.display = 'inline-block';
                            // Manually trigger input event for character count display
                            storyContentInput.dispatchEvent(new Event('input'));
                            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of form
                        }
                    });
                });

                document.querySelectorAll('.btn.delete').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const storyIdToDelete = e.target.dataset.id;
                        const thumbnailPathToDelete = e.target.dataset.thumbnail;

                        if (confirm("Are you sure you want to delete this story? This action cannot be undone.")) {
                            try {
                                // Delete from Firestore
                                await deleteDoc(doc(db, "stories", storyIdToDelete));

                                // Delete thumbnail from Storage
                                await deleteThumbnail(thumbnailPathToDelete);

                                showMessage("Story deleted successfully!", "success");
                            } catch (error) {
                                console.error("Error deleting story:", error);
                                showMessage("Error deleting story: " + error.message, "error");
                            }
                        }
                    });
                });
            }, (error) => {
                storyListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">Error loading your stories.</p>';
                console.error("Error listening to stories:", error);
            });
        }
    </script>
</body>
</html>
